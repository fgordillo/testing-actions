name: Propagate branches

on:
  push:
    branches:
      - main
      - release

jobs:
  propagate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine target branch
        id: map
        run: |
          case "${GITHUB_REF_NAME}" in
            main) echo "target=release" >> $GITHUB_OUTPUT ;;
            release) echo "target=dev" >> $GITHUB_OUTPUT ;;
            *) echo "target=" >> $GITHUB_OUTPUT ;;
          esac

      - name: Skip if no target branch
        if: steps.map.outputs.target == ''
        run: echo "No target branch for this source branch. Skipping..."

      - name: Configure git
        if: steps.map.outputs.target != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create propagation branch and merge
        id: merge
        if: steps.map.outputs.target != ''
        run: |
          TARGET="${{ steps.map.outputs.target }}"
          SOURCE="${{ github.ref_name }}"
          TS=$(date +"%Y%m%d-%H%M%S")
          BRANCH="auto-propagation/${TS}-${SOURCE}-to-${TARGET}"

          # Fetch all branches
          git fetch origin "${TARGET}"
          git fetch origin "${SOURCE}"

          # Delete the branch if it exists remotely
          git push origin --delete "${BRANCH}" 2>/dev/null || true

          # Create new branch from target
          git checkout -b "${BRANCH}" "origin/${TARGET}"

          # Attempt to merge source into the new branch
          if git merge "origin/${SOURCE}" --no-edit; then
            echo "conflict=false" >> $GITHUB_OUTPUT
            echo "Merge successful"
            git push origin "${BRANCH}"
          else
            echo "conflict=true" >> $GITHUB_OUTPUT
            git merge --abort
            git push origin "${BRANCH}"
            exit 0
          fi

          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

      - name: Create PR
        id: pr
        if: steps.map.outputs.target != ''
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Initialize pr-created to false
          echo "pr-created=false" >> $GITHUB_OUTPUT

          # Check if PR already exists
          EXISTING_PR=$(gh pr list \
            --base "${{ steps.map.outputs.target }}" \
            --head "${{ steps.merge.outputs.branch }}" \
            --json number \
            --jq '.[0].number // empty' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "pull-request-number=${EXISTING_PR}" >> $GITHUB_OUTPUT
            echo "pr-created=true" >> $GITHUB_OUTPUT
            echo "PR already exists: #${EXISTING_PR}"
          else
            PR_JSON=$(gh pr create \
              --base "${{ steps.map.outputs.target }}" \
              --head "${{ steps.merge.outputs.branch }}" \
              --title "Propagate: ${{ github.ref_name }} â†’ ${{ steps.map.outputs.target }}" \
              --body "Auto PR: ${{ github.ref_name }} to ${{ steps.map.outputs.target }}. Copilot helps with conflicts." \
              --label "auto-propagation" \
              --json number,url 2>/dev/null)

            PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number // empty')
            PR_URL=$(echo "$PR_JSON" | jq -r '.url // empty')

            if [ -n "$PR_NUMBER" ]; then
              echo "pull-request-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
              echo "pull-request-url=${PR_URL}" >> $GITHUB_OUTPUT
              echo "pr-created=true" >> $GITHUB_OUTPUT
            else
              echo "Failed to create PR" >&2
            fi
          fi

      - name: Handle PR creation failure with conflicts
        if: >-
          steps.merge.outputs.conflict == 'true' &&
          steps.pr.outputs.pr-created == 'false'
        run: |
          echo "::error::Failed to create PR for propagation with merge conflicts"
          echo "::error::Branch: ${{ steps.merge.outputs.branch }}"
          echo "::error::Source: ${{ github.ref_name }}"
          echo "::error::Target: ${{ steps.map.outputs.target }}"
          echo "::error::Please manually create the PR and resolve conflicts"

      - name: Trigger Copilot Agent on conflict
        if: >-
          steps.merge.outputs.conflict == 'true' &&
          steps.pr.outputs.pr-created == 'true' &&
          steps.pr.outputs.pull-request-number
        uses: github/copilot-agent@v1
        with:
          agent: merge-propagation-agent
          pull-request: ${{ steps.pr.outputs.pull-request-number }}
          instructions: |
            There is a merge conflict between ${{ github.ref_name }}
            and ${{ steps.map.outputs.target }}.
            - Analyze the PR diff.
            - Use git blame to identify authors.
            - Explain how the conflict should be resolved.
            - Mention the developers involved.
            - Request confirmation before applying the resolution.
            - Do not make changes without reviewing the context.
            - If trivial, propose a safe resolution directly.