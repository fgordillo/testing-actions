name: Propagate branches

on:
  push:
    branches:
      - main
      - release

jobs:
  propagate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine target branch
        id: map
        run: |
          case "${GITHUB_REF_NAME}" in
            main) echo "target=release" >> $GITHUB_OUTPUT ;;
            release) echo "target=dev" >> $GITHUB_OUTPUT ;;
            *) echo "target=" >> $GITHUB_OUTPUT ;;
          esac

      - name: Skip if no target branch
        if: steps.map.outputs.target == ''
        run: echo "No target branch for this source branch. Skipping..."

      - name: Configure git
        if: steps.map.outputs.target != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create propagation branch and merge
        id: merge
        if: steps.map.outputs.target != ''
        run: |
          TARGET="${{ steps.map.outputs.target }}"
          SOURCE="${GITHUB_REF_NAME}"
          TS=$(date +"%Y%m%d-%H%M%S")
          BRANCH="auto-propagation/${TS}-${SOURCE}-to-${TARGET}"

          # Fetch branches
          git fetch origin "${TARGET}"
          git fetch origin "${SOURCE}"

          # Delete branch remotely if exists
          git push origin --delete "${BRANCH}" 2>/dev/null || true

          # Create new branch from target
          git checkout -b "${BRANCH}" "origin/${TARGET}"

          # Attempt merge
          if git merge "origin/${SOURCE}" --no-edit; then
            echo "conflict=false" >> $GITHUB_OUTPUT
          else
            echo "conflict=true" >> $GITHUB_OUTPUT
            # Don't abort the merge - instead, commit the conflicted state
            # This allows us to push the branch and create a PR showing the conflicts
            # The PR will be labeled and titled to indicate conflicts need resolution
            
            # Check if there are any changes to commit (there should be conflict markers)
            if git diff --name-only --diff-filter=U | grep -q .; then
              git add -A
              git commit -m "Merge ${SOURCE} into ${TARGET} (with conflicts)"
            else
              echo "::warning::Merge failed but no unmerged files found. This is unexpected."
              exit 1
            fi
          fi

          # Push the branch
          git push origin "${BRANCH}" --force-with-lease

          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

      - name: Create PR
        id: pr
        if: steps.map.outputs.target != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "pr-created=false" >> "$GITHUB_OUTPUT"

          # Debug: list remote branches
          git fetch origin
          git branch -r

          # Try getting existing PR by matching head and base
          EXISTING_PR=$(gh pr list \
            --base "${{ steps.map.outputs.target }}" \
            --head "${{ steps.merge.outputs.branch }}" \
            --repo "${GITHUB_REPOSITORY}" || true)

          if [ -n "$EXISTING_PR" ]; then
            # Parse PR number from first line of output (format: "#<number> <title>")
            PR_NUMBER=$(echo "$EXISTING_PR" | head -n1 | awk '{print $1}' | tr -d '#')
            echo "pull-request-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "pr-created=true" >> $GITHUB_OUTPUT
          else
            # Prepare PR body with conflict warning if needed
            if [ "${{ steps.merge.outputs.conflict }}" == "true" ]; then
              PR_TITLE="Propagate: ${{ github.ref_name }} → ${{ steps.map.outputs.target }} [CONFLICTS]"
              PR_BODY="⚠️ **Merge conflicts detected!** This is an automated propagation PR from \`${{ github.ref_name }}\` to \`${{ steps.map.outputs.target }}\`. **Action required:** Please resolve the merge conflicts manually before merging this PR."
              LABELS="auto-propagation,merge-conflict"
            else
              PR_TITLE="Propagate: ${{ github.ref_name }} → ${{ steps.map.outputs.target }}"
              PR_BODY="Auto PR: ${{ github.ref_name }} to ${{ steps.map.outputs.target }}"
              LABELS="auto-propagation"
            fi

            PR_OUTPUT=$(gh pr create \
              --base "${{ steps.map.outputs.target }}" \
              --head "${{ steps.merge.outputs.branch }}" \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --label "$LABELS" \
              --repo "${GITHUB_REPOSITORY}" || true)

            # Extract PR number from the output URL: https://github.com/<owner>/<repo>/pull/<number>
            PR_NUMBER=$(echo "$PR_OUTPUT" | grep -oE '/pull/[0-9]+' | grep -oE '[0-9]+')
            if [ -n "$PR_NUMBER" ]; then
              echo "pull-request-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
              echo "pr-created=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Handle merge conflicts
        if: steps.merge.outputs.conflict == 'true'
        run: |
          echo "::warning::Merge conflict detected for propagation branch '${{ steps.merge.outputs.branch }}'"
          if [ "${{ steps.pr.outputs.pr-created }}" != "true" ]; then
            echo "::warning::PR could not be created automatically. Please resolve manually."
          else
            echo "::warning::PR #${{ steps.pr.outputs.pull-request-number }} created with conflicts. Review manually."
          fi

      - name: Comment on PR about conflict
        if: steps.merge.outputs.conflict == 'true' && steps.pr.outputs.pr-created == 'true'
        run: |
          gh pr comment "${{ steps.pr.outputs.pull-request-number }}" \
            --body "⚠️ Merge conflict detected in this PR. Please resolve manually."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
